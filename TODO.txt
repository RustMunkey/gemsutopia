ğŸ”’ GEMSUTOPIA SECURITY AUDIT REPORT                                                           
                                                                                                
  Executive Summary                                                                             
                                                                                                
  This is a gemstone e-commerce site with Supabase backend, Stripe/PayPal/Crypto payments, and  
  an admin dashboard. The audit revealed critical security vulnerabilities that require         
  immediate attention.                                                                          
                                                                                                
  ---                                                                                           
  ğŸš¨ CRITICAL ISSUES (Fix Immediately)                                                          
                                                                                                
  1. Exposed Supabase Keys in Source Code                                                       
                                                                                                
  File: src/lib/supabase.ts (lines 4-6)                                                         
  - Service role key and anon key are hardcoded as fallbacks                                    
  - These keys are visible in compiled JS, git history, and browser DevTools                    
  - Impact: Full database bypass of Row Level Security                                          
                                                                                                
  2. Hardcoded JWT Secret                                                                       
                                                                                                
  Files: Multiple (middleware.ts:72, adminAuth.ts:4, products/route.ts:13, etc.)                
  const JWT_SECRET = process.env.JWT_SECRET ||                                                  
  'your-super-secret-jwt-key-change-this-in-production';                                        
  - Impact: Attackers can forge admin tokens using the default secret                           
                                                                                                
  3. Order IDOR - Any User Can View Any Order                                                   
                                                                                                
  File: src/app/api/orders/[id]/route.ts                                                        
  - GET endpoint has no authentication                                                          
  - Returns full PII: customer name, email, phone, address, payment details                     
  - Attack: GET /api/orders/{any-uuid} exposes all customer data                                
                                                                                                
  4. Client-Side Price Manipulation                                                             
                                                                                                
  Files: GemPouchContext.tsx, CheckoutFlow.tsx, PaymentForm.tsx                                 
  - Prices stored in localStorage, calculated client-side                                       
  - Server never validates prices against database before payment                               
  - Attack: Modify localStorage â†’ pay $1 for $1000 item                                         
                                                                                                
  5. Admin Login Security Disabled                                                              
                                                                                                
  File: src/app/api/admin/login/route.ts (lines 72-147)                                         
  - Rate limiting: DISABLED (commented out)                                                     
  - IP allowlist: DISABLED (commented out)                                                      
  - Suspicious login detection: DISABLED                                                        
  - Captcha bypass: if (captchaToken !== 'bypassed') allows skipping captcha                    
                                                                                                
  6. Payment Amount Not Verified                                                                
                                                                                                
  - Stripe: Session verification doesn't compare amount_total to order amount                   
  - PayPal: Amount sent from frontend without server validation                                 
  - Crypto: Transaction amounts client-calculated, never verified on-chain                      
                                                                                                
  ---                                                                                           
  âš ï¸ HIGH SEVERITY ISSUES                                                                       
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                  Issue                  â”‚          Location           â”‚       Impact       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ In-memory rate limiting (lost on        â”‚ apiAuth.ts, adminAuth.ts    â”‚ Brute force        â”‚
  â”‚ restart)                                â”‚                             â”‚ attacks            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Weak 2FA code generation                â”‚ twoFactor.ts:15             â”‚ Predictable codes  â”‚
  â”‚ (Math.random())                         â”‚                             â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ XSS protection uses blacklist approach  â”‚ database.ts:227             â”‚ Bypassable filters â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ No CSRF protection                      â”‚ All state-changing          â”‚ Cross-site attacks â”‚
  â”‚                                         â”‚ endpoints                   â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Inventory race condition                â”‚ orders/route.ts:158-320     â”‚ Overselling        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Wallet addresses stored with PII        â”‚ orders/route.ts:229         â”‚ Privacy violation  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Session manager code exists but unused  â”‚ sessionManager.ts           â”‚ Dead code          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Console logging customer emails         â”‚ send-receipt/route.ts:179   â”‚ Log exposure       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ---                                                                                           
  ğŸ“Š Vulnerability Count by Category                                                            
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                                       
  â”‚      Category      â”‚ Critical â”‚ High â”‚ Medium â”‚ Low â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ Authentication     â”‚ 3        â”‚ 4    â”‚ 2      â”‚ 1   â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ Authorization/IDOR â”‚ 2        â”‚ 2    â”‚ 1      â”‚ -   â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ Payment Security   â”‚ 4        â”‚ 3    â”‚ 3      â”‚ 1   â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ Input Validation   â”‚ 1        â”‚ 3    â”‚ 4      â”‚ 2   â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ Data Exposure      â”‚ 2        â”‚ 3    â”‚ 2      â”‚ -   â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ Crypto/Wallet      â”‚ 3        â”‚ 4    â”‚ 3      â”‚ -   â”‚                                       
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                                       
  â”‚ TOTAL              â”‚ 15       â”‚ 19   â”‚ 15     â”‚ 4   â”‚                                       
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                                       
  ---                                                                                           
  ğŸ”§ Immediate Action Items                                                                     
                                                                                                
  Must Fix Before Going Live:                                                                   
                                                                                                
  1. Rotate all keys immediately:                                                               
    - Supabase service role key                                                                 
    - Supabase anon key                                                                         
    - JWT secret                                                                                
    - Remove all hardcoded fallbacks from code                                                  
  2. Fix the Order IDOR:                                                                        
  // Add to GET /api/orders/[id]                                                                
  const user = await verifyAuth(request);                                                       
  if (order.customer_email !== user.email) return 401;                                          
  3. Server-side price validation:                                                              
    - Fetch current prices from DB before payment                                               
    - Compare payment processor amount to calculated total                                      
  4. Re-enable admin login security:                                                            
    - Uncomment rate limiting                                                                   
    - Uncomment IP allowlist                                                                    
    - Remove captcha bypass                                                                     
  5. Move to Redis for rate limiting (in-memory doesn't work with multiple instances)           
  6. Add authentication to:                                                                     
    - GET /api/orders/[id]                                                                      
    - GET /api/site-content/[id]                                                                
    - Wishlist manipulation endpoints                                                           
                                                                                                
  ---                                                                                           
  ğŸ“ Files Requiring Immediate Attention                                                        
                                                                                                
  src/lib/supabase.ts              â† Remove hardcoded keys                                      
  src/app/api/orders/[id]/route.ts â† Add authentication                                         
  src/app/api/admin/login/route.ts â† Re-enable security                                         
  middleware.ts                     â† Remove default JWT secret                                 
  src/app/api/orders/route.ts      â† Add price validation                                       
  src/contexts/GemPouchContext.tsx â† Don't trust client prices                                  
                                                                                                
  ---                                                                                           
  âœ… What's Done Well                                                                           
                                                                                                
  - Supabase parameterized queries (prevents SQL injection)                                     
  - Security middleware structure exists                                                        
  - Input sanitization functions implemented                                                    
  - Admin/user auth separation conceptually correct                                             
  - SameSite cookies on admin tokens                                                            
                                                                                                
  ---                                                                                           
  Summary                                                                                       
                                                                                                
  The site has fundamental security issues that would allow attackers to:                       
  1. Access any customer's order/PII                                                            
  2. Forge admin access                                                                         
  3. Pay any amount for products                                                                
  4. Bypass all login protections                                                               
                                                                                                
  Do not go live until critical issues are resolved.